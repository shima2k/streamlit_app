import streamlit as st
import qrcode
import pandas as pd
from datetime import datetime
import cv2
import tempfile
import os

# -------------------- Cáº¥u hÃ¬nh trang --------------------
st.set_page_config(page_title="Há»‡ thá»‘ng Ä‘iá»ƒm danh QR", page_icon="ğŸ“", layout="wide")

st.title("ğŸ“ Há»† THá»NG ÄIá»‚M DANH Há»ŒC SINH Báº°NG MÃƒ QR")

menu = st.sidebar.radio("ğŸ“Œ Chá»n chá»©c nÄƒng", ["ğŸ·ï¸ Táº¡o mÃ£ QR", "ğŸ“¸ Äiá»ƒm danh", "ğŸ“… Thá»‘ng kÃª"])

# -------------------- 1ï¸âƒ£ SINH MÃƒ QR --------------------
if menu == "ğŸ·ï¸ Táº¡o mÃ£ QR":
    st.subheader("ğŸ“‡ Táº¡o mÃ£ QR cho há»c sinh")
    name = st.text_input("TÃªn há»c sinh")
    student_id = st.text_input("MÃ£ há»c sinh (vÃ­ dá»¥: HS001)")
    classroom = st.text_input("Lá»›p (vÃ­ dá»¥: 10A1)")

    if st.button("ğŸ Táº¡o mÃ£ QR"):
        if name and student_id and classroom:
            data = f"{student_id} - {name} - {classroom}"
            qr = qrcode.make(data)
            os.makedirs("qr_codes", exist_ok=True)
            qr_path = f"qr_codes/{student_id}.png"
            qr.save(qr_path)

            st.image(qr_path, caption=f"MÃ£ QR cá»§a {name}", width=250)
            with open(qr_path, "rb") as f:
                st.download_button("â¬‡ï¸ Táº£i mÃ£ QR", f, file_name=f"{student_id}.png")
            st.success("âœ… ÄÃ£ táº¡o mÃ£ QR thÃ nh cÃ´ng!")
        else:
            st.warning("âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin trÆ°á»›c khi táº¡o!")

# -------------------- 2ï¸âƒ£ ÄIá»‚M DANH --------------------
elif menu == "ğŸ“¸ Äiá»ƒm danh":
    st.subheader("ğŸ“· QuÃ©t mÃ£ QR Ä‘á»ƒ Ä‘iá»ƒm danh")

    attendance_file = "attendance.csv"
    if not os.path.exists(attendance_file):
        pd.DataFrame(columns=["ID", "TÃªn há»c sinh", "Lá»›p", "Thá»i gian"]).to_csv(attendance_file, index=False)

    run = st.checkbox("Báº­t camera")
    FRAME_WINDOW = st.image([])

    if run:
        cap = cv2.VideoCapture(0)
        detector = cv2.QRCodeDetector()

        while run:
            ret, frame = cap.read()
            if not ret:
                st.error("KhÃ´ng thá»ƒ má»Ÿ camera!")
                break

            data, bbox, _ = detector.detectAndDecode(frame)
            if data:
                try:
                    ID, name, classroom = data.split(" - ")
                    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    df = pd.read_csv(attendance_file)

                    # Kiá»ƒm tra xem há»c sinh Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay chÆ°a
                    today = datetime.now().strftime("%Y-%m-%d")
                    already = ((df["ID"] == ID) & (df["Thá»i gian"].str.contains(today))).any()

                    if not already:
                        df.loc[len(df)] = [ID, name, classroom, timestamp]
                        df.to_csv(attendance_file, index=False)
                        st.success(f"âœ… {name} ({classroom}) Ä‘Ã£ Ä‘iá»ƒm danh lÃºc {timestamp}")
                    else:
                        st.info(f"âš ï¸ {name} Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay.")
                except Exception as e:
                    st.error(f"âŒ Lá»—i khi Ä‘á»c mÃ£ QR: {e}")

            FRAME_WINDOW.image(frame, channels="BGR")

            # ğŸ†• Báº£ng danh sÃ¡ch há»c sinh Ä‘iá»ƒm danh hÃ´m nay (tá»± cáº­p nháº­t)
            with st.expander("ğŸ“‹ Danh sÃ¡ch há»c sinh Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay", expanded=True):
                df = pd.read_csv(attendance_file)
                today_df = df[df["Thá»i gian"].str.contains(datetime.now().strftime("%Y-%m-%d"))]
                st.dataframe(today_df.sort_values(by="Thá»i gian", ascending=False))

        cap.release()

    else:
        # Náº¿u camera táº¯t váº«n hiá»‡n danh sÃ¡ch cÅ©
        if os.path.exists(attendance_file):
            st.write("ğŸ“‹ Danh sÃ¡ch há»c sinh Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay:")
            df = pd.read_csv(attendance_file)
            today_df = df[df["Thá»i gian"].str.contains(datetime.now().strftime("%Y-%m-%d"))]
            st.dataframe(today_df.sort_values(by="Thá»i gian", ascending=False))
        else:
            st.info("ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh nÃ o.")

# -------------------- 3ï¸âƒ£ THá»NG KÃŠ --------------------
elif menu == "ğŸ“… Thá»‘ng kÃª":
    st.subheader("ğŸ“Š Thá»‘ng kÃª Ä‘iá»ƒm danh")
    if os.path.exists("attendance.csv"):
        df = pd.read_csv("attendance.csv")
        df["NgÃ y"] = df["Thá»i gian"].str[:10]

        col1, col2 = st.columns(2)
        with col1:
            st.metric("ğŸ‘¨â€ğŸ“ Tá»•ng sá»‘ lÆ°á»£t Ä‘iá»ƒm danh", len(df))
        with col2:
            st.metric("ğŸ“… Sá»‘ ngÃ y cÃ³ Ä‘iá»ƒm danh", df["NgÃ y"].nunique())

        selected_day = st.date_input("Chá»n ngÃ y Ä‘á»ƒ xem chi tiáº¿t", datetime.now().date())
        selected_day_str = selected_day.strftime("%Y-%m-%d")
        filtered = df[df["Thá»i gian"].str.contains(selected_day_str)]

        if len(filtered) > 0:
            st.success(f"ğŸ“‹ Danh sÃ¡ch há»c sinh Ä‘Ã£ Ä‘iá»ƒm danh ngÃ y {selected_day_str}:")
            st.dataframe(filtered)
        else:
            st.warning(f"KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh cho ngÃ y {selected_day_str}.")

        st.download_button("ğŸ“¥ Táº£i toÃ n bá»™ dá»¯ liá»‡u Ä‘iá»ƒm danh", open("attendance.csv", "rb"), file_name="attendance.csv")

    else:
        st.info("â— ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh nÃ o Ä‘á»ƒ thá»‘ng kÃª.")
